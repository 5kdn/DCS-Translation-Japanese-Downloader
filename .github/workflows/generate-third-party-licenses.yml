# ------------------------------------------------------------
# Workflow Name : Generate-Third-Party-Licenses
# Trigger       : pull_request to master
# Purpose       :
#   - package.json / pnpm-lock.yaml の変更に応じて
#     サードパーティライセンス情報を自動生成し整合性を検証する
#   - 手動実行 (workflow_dispatch) 時は
#     最新ライセンス情報を生成して更新用PRを作成する
# ------------------------------------------------------------
name: Generate-Third-Party-Licenses

on:
  pull_request:
    branches:
      - master
    paths:
      - "**/package.json"
      - "pnpm-lock.yaml"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: licenses-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: "24"
  PNPM_VERSION: "10"

jobs:
  pr-licenses-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: pnpm install
        run: pnpm install --frozen-lockfile

      - name: Generate LICENSES
        run: >
          rm -rf src/assets/LICENSES
          && pnpm generate-licenses

      - name: Check diff
        run: |
          git add -N src/assets/LICENSES || true
          git diff --exit-code -- src/assets/LICENSES || { echo 'src/assets/LICENSES is outdated. Regenerate and commit.'; exit 1; }

  manual-update-pr:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: pnpm install
        run: pnpm install --frozen-lockfile

      - name: Generate LICENSES
        run: >
          rm -rf src/assets/LICENSES
          && pnpm generate-licenses

      - name: Create update PR
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "chore(licenses): regenerate src/assets/LICENSES"
          title: "chore(licenses): regenerate src/assets/LICENSES"
          body: "Auto-generated by Licenses workflow."
          branch: "chore/src/assets/LICENSES"
          delete-branch: true
          add-paths: |
            src/assets/LICENSES/**
